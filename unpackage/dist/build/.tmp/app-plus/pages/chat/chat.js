(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"1a5d":function(e,o,t){"use strict";(function(e){Object.defineProperty(o,"__esModule",{value:!0}),o.default=void 0;var i=s(t("e2d3")),n=t("2f62");function s(e){return e&&e.__esModule?e:{default:e}}function r(e){for(var o=1;o<arguments.length;o++){var t=null!=arguments[o]?arguments[o]:{},i=Object.keys(t);"function"===typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.forEach(function(o){a(e,o,t[o])})}return e}function a(e,o,t){return o in e?Object.defineProperty(e,o,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[o]=t,e}var d=function(){return t.e("components/cmd-nav-bar/cmd-nav-bar").then(t.bind(null,"35f5"))},m=function(){return t.e("components/emotion/index").then(t.bind(null,"29df"))},h={name:"Chat",components:{emotion:m,cmdNavBar:d},data:function(){return{textMsg:"",isHistoryLoading:!1,scrollAnimation:!1,scrollTop:0,scrollToView:"",msgList:[],msgImgList:[],willStop:!1,isVoice:!0,voiceTis:"发红包",recordTis:"手指上滑 取消发送",recording:!1,initPoint:{identifier:0,Y:0},recordTimer:null,recordLength:0,popupLayerClass:"",hideMore:!0,hideEmoji:!0,emojiList:[{}],emojiPath:"",windowsState:"",redenvelopeData:{rid:-1,from:"",face:"",blessing:"",money:0,userName:""},room:{roomType:"",roomTypeName:"",roomSubType:"",roomId:"",isAuth:"",userId:"",userName:"",nickName:"",onTheVillageMoney:""},mine:{id:0,userName:"",face:"",nickName:""},subModalName:"",redPacketMsg:"",redPacketIndex:-1,cashPledge:"",ifOnShow:!1,onTheVillageInfo:{type:"",roomId:"",userId:"",userName:"",onTheVillageMoney:""},pageNum:1,pageSize:10,listSize:0}},computed:r({},(0,n.mapState)(["hasLogin","userInfo","getMsg"])),watch:{getMsg:function(e){e.msg.roomId==this.room.roomId&&this.screenMsg(e)}},onUnload:function(){},mounted:function(){this.$mysocket.connectserver(111)},destroyed:function(){this.$mysocket.ws.close()},onLoad:function(e){var o=JSON.parse(e.room);this.mine=this.userInfo.user,this.emojiList=i.default.imgArr[1].emojiList,this.room.roomTypeName=e.roomTypeName,this.room.roomType=o.roomType,this.room.roomSubType=o.roomSubType,this.room.roomId=o.id,this.room.isAuth=o.isAuth,this.myuid=this.mine.id,this.getMsgList(),3==this.room.roomType&&this.getOnTheVillage()},onHide:function(){},onShow:function(){this.scrollTop=9999999},methods:{textareaFocus:function(){"showLayer"==this.popupLayerClass&&0==this.hideMore&&this.hideDrawer()},chooseEmoji:function(){this.hideMore=!0,this.hideEmoji?(this.hideEmoji=!1,this.openDrawer()):this.hideDrawer()},switchVoice:function(){this.hideDrawer(),this.isVoice=!this.isVoice},onTheVillage:function(){this.onTheVillageInfo.roomId=this.room.roomId,this.onTheVillageInfo.userId=this.mine.id,this.onTheVillageInfo.userName=this.mine.userName,this.room.userId!=this.mine.id?this.subModalName="onTheVillageModal":this.toOnTheVillage()},toOnTheVillage:function(){var e=this;this.onTheVillageInfo.type=this.room.userId==this.mine.id?"2":"1",this.onTheVillageInfo.roomType=this.room.roomType,this.onTheVillageInfo.roomSubType=this.room.roomSubType,this.$apiconfig.onTheVillage_f({data:this.onTheVillageInfo}).then(function(o){new Date;var t={type:"village",msg:{roomId:e.room.roomId,villageInfoType:e.onTheVillageInfo.type,userinfo:{userId:e.onTheVillageInfo.userId,userName:e.onTheVillageInfo.userName,onTheVillageMoney:e.onTheVillageInfo.onTheVillageMoney}}};e.$mysocket.ws.send({data:JSON.stringify(t)}),e.onTheVillageInfo.roomId="",e.onTheVillageInfo.userId="",e.onTheVillageInfo.onTheVillageMoney="",e.subModalName="",e.room.userId="",e.room.userName=""})},getOnTheVillage:function(){var e=this;this.$apiconfig.getOnTheVillage_f({data:this.room}).then(function(o){o.data.data.rows?(e.room.userId=o.data.data.rows.userId,e.room.userName=o.data.data.rows.userName,e.room.nickName=o.data.data.rows.nickName,e.room.onTheVillageMoney=o.data.data.rows.onTheVillageMoney):(e.room.userId="",e.room.userName="",e.room.nickName="",e.room.onTheVillageMoney="")})},handleBack:function(){this.$mysocket.ws.close();var o={roomId:this.room.roomId,userId:this.mine.id};this.$apiconfig.quitRoom_f({data:o}).then(function(e){}),e.navigateBack()},handleMore:function(){e.navigateTo({url:"/pages/chat/more/more?roomId="+this.room.roomId})},screenMsg:function(o){if("system"==o.type)switch(o.msg.type){case"text":this.addSystemTextMsg(o);break;case"redEnvelope":this.addSystemRedEnvelopeMsg(o);break}else if("user"==o.type){switch(o.msg.type){case"redEnvelope":this.addRedEnvelopeMsg(o);break}o.msg.userinfo.uid!=this.mine.id&&e.vibrateLong()}else"village"==o.type&&this.room.roomId==o.msg.roomId&&(1==o.msg.villageInfoType?(this.room.userId=o.msg.userinfo.userId,this.room.userName=o.msg.userinfo.userName,this.room.onTheVillageMoney=o.msg.userinfo.onTheVillageMoney):(this.room.userId="",this.room.userName="",this.room.onTheVillageMoney=""));"village"!=o.type&&this.$nextTick(function(){this.scrollToView="msg"+o.msg.id})},loadHistory:function(e){var o=this;if(!this.isHistoryLoading&&(this.pageNum++,!(this.pageNum>Math.ceil(this.listSize/this.pageSize)))){this.isHistoryLoading=!0,this.scrollAnimation=!1;var t=this.msgList[0].msg.id,i=[];this.$apiconfig.getrecentmsg_f({data:{roomId:this.room.roomId,userId:this.mine.id,pageNum:this.pageNum,pageSize:this.pageSize}}).then(function(e){if(i=e.data.data.rows,o.listSize=e.data.data.total,i.length>0){for(var n=0;n<i.length;n++)"user"==i[n].type&&"img"==i[n].msg.type&&(i[n].msg.content=o.setPicSize(i[n].msg.content),o.msgImgList.unshift(i[n].msg.content.url)),i[n].msg.id=Math.floor(1e3*Math.random()+1),o.msgList.unshift(i[n]);o.$nextTick(function(){this.scrollToView="msg"+t,this.$nextTick(function(){this.scrollAnimation=!0})})}o.isHistoryLoading=!1})}},getMsgList:function(){var e=this,o=[];this.$apiconfig.getrecentmsg_f({data:{roomId:this.room.roomId,userId:this.mine.id,pageNum:this.pageNum,pageSize:this.pageSize}}).then(function(t){if(o=t.data.data.rows,e.listSize=t.data.data.total,o.length>0)for(var i=0;i<o.length;i++)"user"==o[i].type&&"img"==o[i].msg.type&&(o[i].msg.content=e.setPicSize(o[i].msg.content),e.msgImgList.push(o[i].msg.content.url));e.msgList=o,e.$nextTick(function(){this.scrollTop=9999,this.$nextTick(function(){this.scrollAnimation=!0})})})},setPicSize:function(o){var t=e.upx2px(350),i=e.upx2px(350);if(o.w>t||o.h>i){var n=o.w/o.h;o.w=n>1?t:i*n,o.h=n>1?t/n:i}return o},showMore:function(){this.hideEmoji=!0,this.hideMore?(this.hideMore=!1,this.openDrawer()):this.hideDrawer()},openDrawer:function(){this.popupLayerClass="showLayer"},hideDrawer:function(){var e=this;this.popupLayerClass="",setTimeout(function(){e.hideMore=!0,e.hideEmoji=!0},150)},handRedEnvelopes:function(){e.navigateTo({url:"hand/hand?roomType="+this.room.roomType+"&roomTypeName="+this.room.roomTypeName+"&roomSubType="+this.room.roomSubType+"&roomId="+this.room.roomId}),this.hideDrawer()},addRedEnvelopeMsg:function(e){this.msgList.push(e)},addSystemTextMsg:function(e){this.msgList.push(e)},addSystemRedEnvelopeMsg:function(e){this.msgList.push(e)},openRedEnvelope:function(e,o){this.redPacketMsg=e,this.redPacketIndex=o,e.content.isRobed||1==this.room.roomType?this.toOpenRedEnvelope():this.subModalName="cashPledgeModal"},hideSubModal:function(){this.subModalName="",this.cashPledge=""},toOpenRedEnvelope:function(){var o=this;this.subModalName="";var t=this.redPacketMsg,i=this.redPacketIndex;t.content.rid;e.showLoading({title:"加载中..."});var n={msgId:t.id,userId:this.mine.id,roomType:this.room.roomType,roomSubType:this.room.roomSubType,dot:t.content.dot,cashPledge:this.cashPledge,roomId:this.room.roomId};this.$apiconfig.robRedEnvelope_f({data:n}).then(function(n){n.data.success?(o.redenvelopeData=n.data.data,o.redenvelopeData.userName=t.userinfo.username,"已领完"==o.redenvelopeData.money||t.content.isRobed||(o.sendSystemMsg({text:"你领取了"+(t.userinfo.uid==o.mine.id?"自己":t.userinfo.username)+"的红包"},"redEnvelope"),o.msgList[i].msg.content.isRobed=!0)):e.showToast({icon:"none",title:n.data.errorHint}),e.hideLoading(),o.windowsState="show"})},closeRedEnvelope:function(){var e=this;this.windowsState="hide",setTimeout(function(){e.windowsState=""},200)},sendSystemMsg:function(e,o){var t=this.msgList[this.msgList.length-1].msg.id;t++;var i={type:"system",msg:{id:t,type:o,content:e}};this.screenMsg(i)},toDetails:function(o){e.navigateTo({url:"details/details?rid="+o.rid+"&userId="+this.mine.id})},discard:function(){}}};o.default=h}).call(this,t("6e42")["default"])},"3a9d":function(e,o,t){"use strict";(function(e){t("55c5"),t("921b");i(t("66fd"));var o=i(t("d3e8"));function i(e){return e&&e.__esModule?e:{default:e}}e(o.default)}).call(this,t("6e42")["createPage"])},"9ed2":function(e,o,t){"use strict";t.r(o);var i=t("1a5d"),n=t.n(i);for(var s in i)"default"!==s&&function(e){t.d(o,e,function(){return i[e]})}(s);o["default"]=n.a},c8cf:function(e,o,t){},cfed:function(e,o,t){"use strict";var i=t("c8cf"),n=t.n(i);n.a},d3e8:function(e,o,t){"use strict";t.r(o);var i=t("db11"),n=t("9ed2");for(var s in n)"default"!==s&&function(e){t.d(o,e,function(){return n[e]})}(s);t("cfed");var r,a=t("f0c5"),d=Object(a["a"])(n["default"],i["b"],i["c"],!1,null,null,null,!1,i["a"],r);o["default"]=d.exports},db11:function(e,o,t){"use strict";var i,n=function(){var e=this,o=e.$createElement;e._self._c},s=[];t.d(o,"b",function(){return n}),t.d(o,"c",function(){return s}),t.d(o,"a",function(){return i})}},[["3a9d","common/runtime","common/vendor"]]]);